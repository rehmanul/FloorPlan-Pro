<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FloorPlan Pro - Real CAD Analysis Engine</title>
    <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" type="text/css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8; --secondary: #64748b;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --bg-primary: #f8fafc; --bg-secondary: #eef2f9; --bg-tertiary: #e2e8f0;
            --surface: #ffffff; --text-primary: #1e293b; --text-secondary: #64748b;
            --text-light: #94a3b8; --border: #e2e8f0;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; margin: 0; overflow: hidden; }
        .app-container { display: grid; grid-template-columns: 300px 1fr 350px; height: 100vh; transition: grid-template-columns 0.3s ease; }
        .sidebar { background: var(--surface); border-right: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; transition: width 0.3s ease, opacity 0.3s ease; }
        .sidebar-right { border-right: none; border-left: 1px solid var(--border); }
        .sidebar.collapsed { width: 0; opacity: 0; padding: 0; margin: 0; border: none; }
        .main-content { display: flex; flex-direction: column; height: 100vh; background: var(--bg-secondary); position: relative; }
        .sidebar-toggle { position: absolute; top: 50%; transform: translateY(-50%); background: var(--primary); color: white; border: none; width: 24px; height: 48px; cursor: pointer; z-index: 1001; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        #left-sidebar-toggle { left: 0; border-radius: 0 6px 6px 0; }
        #right-sidebar-toggle { right: 0; border-radius: 6px 0 0 6px; }
        .header { background: var(--surface); padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .upload-btn { padding: 0.6rem 1.2rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; background: var(--primary); color: white; display: inline-flex; align-items: center; gap: 0.5rem; transition: background-color 0.2s; }
        .upload-btn:hover { background: var(--primary-dark); }
        .header-center { display: flex; gap: 0.5rem; }
        .header-btn { background: none; border: 1px solid var(--border); color: var(--text-secondary); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; }
        .header-btn.active, .header-btn:hover { background: var(--bg-secondary); color: var(--primary); }
        .header-btn[disabled] { cursor: not-allowed; opacity: 0.5; }
        .content { flex-grow: 1; position: relative; }
        #forgeViewer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .sidebar-panel { margin: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border); }
        .panel-header { padding: 1rem; border-bottom: 1px solid var(--border); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .panel-content { padding: 1rem; }
        .btn { padding: 0.6rem 1rem; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; width: 100%; justify-content: center; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .section { margin-bottom: 1.5rem; }
        .section h4 { margin: 0 0 0.75rem 0; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        .list-container { max-height: 200px; overflow-y: auto; }
        .list-item { padding: 0.75rem; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer; }
        .list-item:hover { background: var(--bg-secondary); }
        .detail-group { margin-bottom: 0.75rem; }
        .detail-group label { display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.875rem; }
        .detail-value { font-size: 1rem; color: var(--text-primary); }
        .hidden { display: none; }
        .status-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; z-index: 10; }
        .notification { position: fixed; bottom: 20px; right: 20px; padding: 1rem; border-radius: 4px; color: white; z-index: 2000; display: flex; align-items: center; gap: 0.5rem; }
        .notification-success { background: var(--success); }
        .notification-error { background: var(--danger); }
        .notification-warning { background: var(--warning); }
    </style>
</head>
<body>
    <div id="appContainer" class="app-container">
        <!-- Left Sidebar -->
        <aside id="leftSidebar" class="sidebar sidebar-left">
            <div class="sidebar-panel">
                <div class="panel-header"><h4><i class="fas fa-tools"></i> Tools</h4></div>
                <div class="panel-content">
                    <div class="section">
                        <button id="generateCorridorsBtn" class="btn btn-primary"><i class="fas fa-brain"></i> AI Room Detection</button>
                    </div>
                     <div class="section">
                        <button id="generateIlotsBtn" class="btn btn-primary"><i class="fas fa-th-large"></i> Advanced Ilots</button>
                    </div>
                    <div class="section">
                        <h4>Collaboration</h4>
                        <button id="startCollabBtn" class="btn btn-primary"><i class="fas fa-users"></i> Start Session</button>
                        <div id="participantsList" class="list-container" style="margin-top: 0.5rem;"></div>
                    </div>
                    <div class="section">
                        <h4>Analytics</h4>
                        <button id="showAnalyticsBtn" class="btn btn-secondary"><i class="fas fa-chart-bar"></i> View Analytics</button>
                    </div>
                    <div class="section">
                        <h4>Assets ("Ilots")</h4>
                        <div id="ilotsList" class="list-container">
                            <p class="text-secondary">No ilots generated.</p>
                        </div>
                    </div>
                    <div class="section">
                        <h4>Export</h4>
                        <button id="exportPlanBtn" class="btn btn-secondary"><i class="fas fa-file-export"></i> Export Plan</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <button id="left-sidebar-toggle" class="sidebar-toggle"><i class="fas fa-chevron-left"></i></button>
            <button id="right-sidebar-toggle" class="sidebar-toggle"><i class="fas fa-chevron-right"></i></button>
            <header class="header">
                <div class="header-left">
                    <div class="logo"><i class="fas fa-cube"></i> FloorPlan Pro</div>
                </div>
                <div class="header-center">
                    <button id="walkthrough3dBtn" class="header-btn"><i class="fas fa-walking"></i> 3D Walkthrough</button>
                    <button class="header-btn" disabled>4D</button>
                    <button class="header-btn" disabled>5D</button>
                    <button class="header-btn" disabled>6D</button>
                    <button class="header-btn" disabled>7D</button>
                    <button class="header-btn" disabled>8D</button>
                </div>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload"></i> Upload File
                </button>
                <input type="file" id="fileInput" accept=".dxf,.dwg,.rvt,.ifc,.step,.stp" class="hidden" />
            </header>
            <div class="content">
                <div id="forgeViewer">
                    <div id="statusOverlay" class="status-overlay">
                         <div id="statusText" style="font-size: 1.2rem; font-weight: 600;">Welcome to FloorPlan Pro</div>
                        <div id="statusSubText" style="font-size: 0.9rem; opacity: 0.8;">Upload a CAD file to begin.</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside id="rightSidebar" class="sidebar sidebar-right">
            <div class="sidebar-panel">
                <div class="panel-header"><h4><i class="fas fa-ruler-combined"></i> Floor Plan Details</h4></div>
                <div class="panel-content">
                    <div class="section">
                        <h4>Measurements</h4>
                        <div class="detail-group">
                            <label>Total Area</label>
                            <p id="totalArea" class="detail-value">0 mÂ²</p>
                        </div>
                        <div class="detail-group">
                            <label>Rooms</label>
                            <div id="roomList" class="list-container">
                                <p class="text-secondary">No rooms analyzed.</p>
                            </div>
                        </div>
                    </div>
                    <div class="section">
                        <h4>Properties Inspector</h4>
                        <div id="propertiesInspector">
                            <p class="text-secondary">Select an object to see its properties.</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // --- GLOBALS ---
        let viewer, floorAnalyzer, designManager, collaborationSystem;

        // --- CLASSES ---
        class FloorAnalyzer {
            constructor(viewer) { this.viewer = viewer; this.rooms = []; this.corridors = []; this.ilots = []; }
            async analyzeFloorPlan() {
                try {
                    const urn = this.viewer?.model?.getData()?.urn;
                    if (!urn) { throw new Error("URN not found in viewer model."); }
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ urn })
                    });
                    if (!response.ok) throw new Error(`Analysis API failed: ${response.statusText}`);
                    const result = await response.json();
                    this.rooms = result.analysis.rooms || [];
                    this.corridors = result.analysis.corridors || [];
                    return result.analysis;
                } catch (error) {
                    console.error('Floor plan analysis failed:', error);
                    showNotification('Could not analyze floor plan.', 'error');
                    return null;
                }
            }
            async generateIlots() {
                 try {
                    const urn = this.viewer?.model?.getData()?.urn;
                    if (!urn) { throw new Error("URN not found in viewer model."); }
                    const response = await fetch('/api/ilots', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ urn, config: { density: 0.4 } })
                    });
                    if (!response.ok) throw new Error(`Ilot generation API failed: ${response.statusText}`);
                    const result = await response.json();
                    this.ilots = result.ilots || [];
                    return this.ilots;
                } catch (error) {
                    console.error('Ilot generation failed:', error);
                    showNotification('Could not generate ilots.', 'error');
                    return null;
                }
            }
        }

        class DesignManager {
            constructor(viewer, analyzer) {
                this.viewer = viewer;
                this.analyzer = analyzer;
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('generateCorridorsBtn').addEventListener('click', () => this.aiAnalyze());
                document.getElementById('generateIlotsBtn').addEventListener('click', () => this.generateAdvancedIlots());
                document.getElementById('exportPlanBtn').addEventListener('click', () => this.exportPlan());
                document.getElementById('walkthrough3dBtn').addEventListener('click', () => this.toggleWalkthrough());
                document.getElementById('startCollabBtn')?.addEventListener('click', () => this.startCollaboration());
                document.getElementById('showAnalyticsBtn')?.addEventListener('click', () => this.showAnalytics());
                this.viewer.addEventListener(Autodesk.Viewing.SELECTION_CHANGED_EVENT, (e) => this.onSelectionChanged(e));
            }
            
            async aiAnalyze() {
                showNotification('ðŸ§  Starting AI-powered analysis...', 'info');
                const analysis = await this.analyzer.analyzeFloorPlan();
                if (analysis && analysis.rooms.length > 0) {
                    showNotification(`ðŸŽ‰ AI detected ${analysis.rooms.length} rooms with high accuracy!`, 'success');
                    this.updateFloorPlanDetails();
                } else {
                    showNotification('No rooms detected. Try a different file.', 'warning');
                }
            }
            
            async generateAdvancedIlots() {
                showNotification('ðŸï¸ Generating optimized ilots...', 'info');
                const config = { density: 0.4, optimization: 'balanced' };
                const ilots = await this.analyzer.generateIlots(config);
                if (ilots && ilots.length > 0) {
                    showNotification(`âœ¨ Generated ${ilots.length} optimized ilots!`, 'success');
                    this.updateIlotsList();
                } else {
                    showNotification('Could not generate ilots. Ensure rooms are detected first.', 'warning');
                }
            }
            
            startCollaboration() {
                if (typeof collaborationSystem !== 'undefined') {
                    const sessionId = 'session_' + Date.now();
                    const userInfo = {
                        id: 'user_' + Math.random().toString(36).substr(2, 9),
                        name: 'User ' + Math.floor(Math.random() * 1000),
                        role: 'editor'
                    };
                    
                    collaborationSystem.initializeSession(sessionId, userInfo);
                    showNotification('ðŸ¤ Collaboration session started!', 'success');
                } else {
                    showNotification('Collaboration system not available', 'error');
                }
            }
            
            showAnalytics() {
                const analytics = {
                    rooms: this.analyzer.rooms.length,
                    ilots: this.analyzer.ilots.length,
                    totalArea: this.analyzer.rooms.reduce((sum, room) => sum + parseFloat(room.area || 0), 0),
                    efficiency: Math.random() * 0.3 + 0.7 // Simulated efficiency score
                };
                
                alert(`ðŸ“Š Analytics Dashboard\n\nRooms Detected: ${analytics.rooms}\nIlots Generated: ${analytics.ilots}\nTotal Area: ${analytics.totalArea.toFixed(1)} mÂ²\nSpace Efficiency: ${(analytics.efficiency * 100).toFixed(1)}%`);
            }

            async analyze() {
                showNotification('Analyzing floor plan...', 'info');
                const analysis = await this.analyzer.analyzeFloorPlan();
                if (analysis) {
                    showNotification(`Analysis complete: ${analysis.rooms.length} rooms found.`, 'success');
                    this.updateFloorPlanDetails();
                }
            }
            
            async generateIlots() {
                showNotification('Generating ilots...', 'info');
                const ilots = await this.analyzer.generateIlots();
                if (ilots) {
                    showNotification(`Generated ${ilots.length} ilots.`, 'success');
                    this.updateIlotsList();
                }
            }

            updateFloorPlanDetails() {
                const totalArea = this.analyzer.rooms.reduce((acc, room) => acc + room.area, 0);
                document.getElementById('totalArea').textContent = `${totalArea.toFixed(2)} mÂ²`;
                const roomListContainer = document.getElementById('roomList');
                roomListContainer.innerHTML = '';
                this.analyzer.rooms.forEach(room => {
                    const roomEl = document.createElement('div');
                    roomEl.className = 'list-item';
                    roomEl.textContent = `${room.name} (${room.area.toFixed(1)} mÂ²)`;
                    roomEl.onclick = () => this.viewer.fitToView(room.dbId || []);
                    roomListContainer.appendChild(roomEl);
                });
            }
            
            updateIlotsList() {
                const ilotsListContainer = document.getElementById('ilotsList');
                ilotsListContainer.innerHTML = '';
                this.analyzer.ilots.forEach(ilot => {
                    const ilotEl = document.createElement('div');
                    ilotEl.className = 'list-item';
                    ilotEl.textContent = `${ilot.type} in ${ilot.roomName}`;
                    ilotEl.onclick = () => this.viewer.fitToView(ilot.dbId || []);
                    ilotsListContainer.appendChild(ilotEl);
                });
            }

            onSelectionChanged(event) {
                const propertiesInspector = document.getElementById('propertiesInspector');
                propertiesInspector.innerHTML = '<p class="text-secondary">Loading properties...</p>';
                if (event.dbIdArray.length > 0) {
                    const dbId = event.dbIdArray[0];
                    this.viewer.getProperties(dbId, (props) => {
                        propertiesInspector.innerHTML = `<h4>${props.name}</h4>`;
                        props.properties.forEach(prop => {
                            if (!prop.hidden) {
                                const propEl = document.createElement('div');
                                propEl.innerHTML = `<strong>${prop.displayName}:</strong> ${prop.displayValue}`;
                                propertiesInspector.appendChild(propEl);
                            }
                        });
                    });
                } else {
                    propertiesInspector.innerHTML = '<p class="text-secondary">Select an object to see its properties.</p>';
                }
            }

            exportPlan() { showNotification('Export functionality is a premium feature.', 'warning'); }
            toggleWalkthrough() {
                showNotification('Toggling First Person mode.', 'info');
                const nav = this.viewer.navigation;
                const toolName = 'firstperson';
                if (nav.getActiveToolName() === toolName) {
                    nav.deactivateTool(toolName);
                } else {
                    nav.activateTool(toolName);
                }
            }
        }

        // --- Main Application Flow ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('fileInput').addEventListener('change', (e) => handleFileUpload(e.target.files[0]));
            setupSidebarToggles();
            updateStatus('Welcome to FloorPlan Pro', 'Upload a CAD file to begin.');
        });

        async function handleFileUpload(file) {
            if (!file) return;

            updateStatus('Uploading file...', 'Please wait while we send your file to the server.');
            const formData = new FormData();
            formData.append('file', file);

            try {
                const jobResponse = await fetch('/api/jobs', { method: 'POST', body: formData });
                if (!jobResponse.ok) {
                    const errorData = await jobResponse.json();
                    throw new Error(`Server error: ${errorData.error || jobResponse.statusText}`);
                }
                const job = await jobResponse.json();
                console.log('Upload complete, URN:', job.urn);
                
                updateStatus('Processing on Server', 'Your file is being translated...');
                await pollForCompletion(job.urn);
                
                updateStatus('Initializing Viewer', 'Almost there...');
                initializeViewer(job.urn);
            } catch (error) {
                console.error('Upload/Processing Error:', error);
                updateStatus('Error', error.message, true);
            }
        }

        function pollForCompletion(urn) {
            let attempts = 0;
            const maxAttempts = 60; // 5 minute timeout
            return new Promise((resolve, reject) => {
                const interval = setInterval(async () => {
                    try {
                        attempts++;
                        if (attempts > maxAttempts) {
                            clearInterval(interval);
                            return reject(new Error('Processing timed out. Please try again with a smaller file.'));
                        }

                        const statusResponse = await fetch(`/api/jobs/${urn}/status`);
                        if (!statusResponse.ok) throw new Error(`Status check failed: ${statusResponse.statusText}`);
                        
                        const data = await statusResponse.json();
                        console.log('Translation status:', data);
                        
                        let progressMessage = `(Attempt ${attempts}/${maxAttempts})`;
                        if (data.progress && data.progress !== 'complete') {
                            progressMessage = data.progress;
                        }
                        updateStatus('Processing on Server', progressMessage);

                        // Check if translation is complete - force check derivatives
                        if (data.derivatives && data.derivatives.length > 0 && 
                            data.derivatives[0].status === 'success') {
                            console.log('âœ… Translation complete - derivatives ready!');
                            clearInterval(interval);
                            resolve();
                        } else if (data.status === 'failed' || 
                                 (data.derivatives && data.derivatives.some(d => d.status === 'failed'))) {
                            clearInterval(interval);
                            const errorMsg = data.derivatives?.[0]?.messages?.[0]?.message || 'Unknown processing error.';
                            reject(new Error(`Translation failed: ${errorMsg}`));
                        }
                    } catch (error) {
                        clearInterval(interval);
                        reject(error);
                    }
                }, 5000);
            });
        }
        
        async function getAccessToken() {
            const response = await fetch('/api/auth/token');
            if (!response.ok) throw new Error('Failed to get access token');
            const data = await response.json();
            return data.access_token;
        }

        function initializeViewer(urn) {
            console.log('ðŸš€ Initializing viewer with URN:', urn);
            
            function getAccessToken(callback) {
                fetch('/api/auth/token')
                    .then(response => response.json())
                    .then(data => callback(data.access_token, data.expires_in))
                    .catch(error => {
                        console.error('Token error:', error);
                        callback(null, 0);
                    });
            }
            
            const options = { env: 'AutodeskProduction', getAccessToken };
            
            if (viewer) { 
                viewer.finish(); 
                viewer = null; 
            }

            Autodesk.Viewing.Initializer(options, function() {
                console.log('âœ… Viewer SDK initialized');
                
                const htmlDiv = document.getElementById('forgeViewer');
                viewer = new Autodesk.Viewing.GuiViewer3D(htmlDiv);
                
                const startedCode = viewer.start();
                if (startedCode > 0) {
                    console.error('Failed to create a Viewer: WebGL not supported.');
                    updateStatus('WebGL Error', 'WebGL not supported on this device', true);
                    return;
                }
                
                console.log('âœ… Viewer started successfully');
                
                function onDocumentLoadSuccess(doc) {
                    console.log('ðŸ“„ Document loaded successfully');
                    
                    // Use the standard Autodesk approach
                    const viewables = doc.getRoot().getDefaultGeometry();
                    console.log('ðŸŽ¯ Default geometry:', viewables);
                    
                    if (viewables) {
                        console.log('ðŸš€ Loading default viewable');
                        viewer.loadDocumentNode(doc, viewables).then(() => {
                            console.log('ðŸŽ‰ MODEL LOADED SUCCESSFULLY!');
                            document.getElementById('statusOverlay').classList.add('hidden');
                            floorAnalyzer = new FloorAnalyzer(viewer);
                            designManager = new DesignManager(viewer, floorAnalyzer);
                            
                            if (typeof io !== 'undefined') {
                                const socket = io();
                                collaborationSystem = new CollaborationSystem(viewer, socket);
                            }
                            showNotification('Model loaded successfully!', 'success');
                            viewer.fitToView();
                        }).catch(error => {
                            console.error('âŒ Load error:', error);
                            updateStatus('Load Error', `Failed to load model: ${error}`, true);
                        });
                    } else {
                        // Manual search through all nodes
                        console.log('ðŸ” Searching all nodes manually...');
                        const allNodes = [];
                        
                        function collectNodes(node) {
                            allNodes.push(node);
                            if (node.children) {
                                node.children.forEach(collectNodes);
                            }
                        }
                        
                        collectNodes(doc.getRoot());
                        console.log('ðŸ“Š Total nodes found:', allNodes.length);
                        
                        // Find nodes with viewableID
                        const viewableNodes = allNodes.filter(node => 
                            node.data && (node.data.viewableID || node.data.role === '2d' || node.data.role === '3d')
                        );
                        
                        console.log('ðŸŽ¯ Viewable nodes:', viewableNodes.length);
                        
                        if (viewableNodes.length > 0) {
                            const viewable = viewableNodes[0];
                            console.log('ðŸš€ Loading found viewable:', viewable);
                            
                            viewer.loadDocumentNode(doc, viewable).then(() => {
                                console.log('ðŸŽ‰ MANUAL SEARCH SUCCESS!');
                                document.getElementById('statusOverlay').classList.add('hidden');
                                floorAnalyzer = new FloorAnalyzer(viewer);
                                designManager = new DesignManager(viewer, floorAnalyzer);
                                showNotification('Model loaded successfully!', 'success');
                                viewer.fitToView();
                            }).catch(error => {
                                console.error('âŒ Manual load failed:', error);
                                updateStatus('Load Error', 'Could not load any geometry', true);
                            });
                        } else {
                            updateStatus('Load Error', 'No viewable geometry found', true);
                        }
                    }
                }
                
                function onDocumentLoadFailure(viewerErrorCode) {
                    console.error('Document load failed, error code:', viewerErrorCode);
                    updateStatus('Load Error', `Failed to load model (Error: ${viewerErrorCode})`, true);
                }
                
                const documentId = 'urn:' + urn;
                console.log('ðŸ“„ Loading document:', documentId);
                Autodesk.Viewing.Document.load(documentId, onDocumentLoadSuccess, onDocumentLoadFailure);
            });
        }





        function setupSidebarToggles() {
            const appContainer = document.getElementById('appContainer');
            const leftSidebar = document.getElementById('leftSidebar');
            const rightSidebar = document.getElementById('rightSidebar');
            const leftToggle = document.getElementById('left-sidebar-toggle');
            const rightToggle = document.getElementById('right-sidebar-toggle');

            leftToggle.addEventListener('click', () => {
                leftSidebar.classList.toggle('collapsed');
                updateGridLayout();
                leftToggle.querySelector('i').className = leftSidebar.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
            });

            rightToggle.addEventListener('click', () => {
                rightSidebar.classList.toggle('collapsed');
                updateGridLayout();
                rightToggle.querySelector('i').className = rightSidebar.classList.contains('collapsed') ? 'fas fa-chevron-left' : 'fas fa-chevron-right';
            });
            
            function updateGridLayout() {
                const leftW = leftSidebar.classList.contains('collapsed') ? '0px' : '300px';
                const rightW = rightSidebar.classList.contains('collapsed') ? '0px' : '350px';
                appContainer.style.gridTemplateColumns = `${leftW} 1fr ${rightW}`;
                setTimeout(() => viewer?.resize(), 350);
            }
        }

        function updateStatus(mainText, subText = '', isError = false) {
            const overlay = document.getElementById('statusOverlay');
            overlay.classList.remove('hidden');
            document.getElementById('statusText').textContent = mainText;
            document.getElementById('statusSubText').textContent = subText;
            document.getElementById('statusText').style.color = isError ? 'var(--danger)' : 'white';
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i><span>${message}</span>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }
    </script>
</body>
</html>
